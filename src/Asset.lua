
require("src/Util")
require("src/AssetLoader")
require("src/AudioManager")
require("src/FieldAnimator")
require("src/World")

local M = def_module("Asset", nil)

local InstancePolicy = AudioManager.InstancePolicy

local L_FG = World.LayerID.fg
local L_BG = World.LayerID.bg
local L_OG = World.LayerID.og

local tile_id_iota_value = 0
local function ID(value)
	if nil ~= value then
		tile_id_iota_value = value
	else
		tile_id_iota_value = tile_id_iota_value + 1
	end
	return tile_id_iota_value
end

-- assets
-- desc_root [[

M.desc_root = {}

M.desc_root.font = {
	main = {12, default = true},
} -- font

M.desc_root.atlas = {
	intro_seq = {
		tex = {
			{"komiga", 0,0, 256,256},
			{"disclaimer", 0,256, 512,256},
		}
	},
	light = {
		indexed = true,
		size = {256,256},
		tex = {
			{"orb", 0,0},
			{"glow", 1,0},
		}
	},
	tileset = {
		indexed = true,
		size = {32,32},
		tex = {
			-- BG
			{ID(100), 0,2},
			{ID(   ), 0,5, 32,96},
			{ID(   ), 1,5, 32,96},
			{ID(   ), 3,5, 64,96},

			-- FG
			{ID(200), 0,0},
			{ID(   ), 1,0, 32,128},
			{ID(   ), 2,0, 32,128},
			{ID(   ), 3,0, 32,128},

			-- OG
			-- grass
			{ID(300), 1,4},
			{ID(   ), 2,4},
			{ID(   ), 3,4},
			{ID(   ), 4,4},
			{ID(   ), 5,4},
			{ID(   ), 6,4},
			{ID(   ), 7,4},
		}
	},
	static_entities = {
		indexed = true,
		size = {32,32},
		tex = {
			{"edit", 0,0},
			{"arc_torch", 0,1},
		}
	},
	runes = {
		indexed = true,
		size = {32,32},
		tex = {
			{"top_rune_1", 0,0},
			{"top_rune_2", 1,0},

			{"bot_rune_1", 2,0},
			{"bot_rune_2", 3,0},

			{"top_rune_3", 0,1, 32,96},
			{"bot_rune_3", 1,1, 32,96},
		}
	},
} -- atlas

M.desc_root.anim = {
	char_top = {
		duration = 1/60 * 8,
		size = {32,80},
		set = {
			{3},
			{13},
		}
	},
	char_bot = {
		duration = 1/60 * 4,
		size = {32,32},
		set = {
			{3},
			{6},
		}
	},
} -- anim

local function sound_const(name)
	M.desc_root.sound[name] = {
		policy = InstancePolicy.Constant,
		limit = 1,
	}
end

M.desc_root.sound = {} -- sound
	sound_const("bell-1")
	sound_const("bell-2")
	sound_const("bell-3")
	sound_const("drop-1")
	sound_const("drop-2")
	--sound_const("rygg-1")
	sound_const("rygg-2")
	sound_const("rygg-3")
	sound_const("fuu-wave")
	sound_const("whaley-mid")
	sound_const("whaley-whirly")

M.desc_root.music = {
	bgm = {
		loop = true,
		volume = 0.3,
	},
} -- music

local function rune_entity(name, sound_name, corune, height, lsx, lsy, inner_power, inner_height_add)
	M.desc_root.entity[name] = {
		height = height,
		blend_mode = "alpha",
		light = {
			blend_mode = "subtractive",
			kind = "glow",
			sx = lsx,
			sy = lsy,
			inner_power = inner_power,
			inner_height_add = inner_height_add,
		},
		static = {
			atlas = "runes",
			sidx = name,
		},
		rune = {
			sound_name = sound_name,
			corune = corune,
		},
	}
end

M.desc_root.entity = {
	edit = {
		height = 32,
		static = {
			atlas = "static_entities",
			sidx = "edit",
		},
	},
	arc_torch = {
		height = 32,
		static = {
			atlas = "static_entities",
			sidx = "arc_torch",
		},
		light = {
			kind = "glow",
			blend_mode = "subtractive",
			sx = 0.10,
			sy = 0.60,
			inner_power = 20.00,
			inner_height_add = 0,
		},
	},
	char_top = {
		controlled = true,
		height = 80,
		light = {
			sx = 0.55,
			sy = 1.25,
			inner_power = 40.00,
		},
		anim_name = "char_top",
		anim = {
			idle = {
				index = 1,
				mode = Animator.Mode.Bounce,
				passive = true,
			},
			move = {
				index = 2,
				mode = Animator.Mode.Loop,
				passive = false,
			},
		}
	},
	char_bot = {
		controlled = true,
		height = 32,
		light = {
			sx = 0.55,
			sy = 0.75,
			inner_power = 40.00,
		},
		anim_name = "char_bot",
		anim = {
			idle = {
				index = 1,
				mode = Animator.Mode.Bounce,
				passive = true,
			},
			move = {
				index = 2,
				mode = Animator.Mode.Loop,
				passive = false,
			},
		}
	},
} -- entity
	rune_entity("top_rune_1", "bell-2"			, "bot_rune_1", 32, 0.20, 1.40, 20, 0.05)
	rune_entity("top_rune_2", "rygg-2"			, "bot_rune_2", 32, 0.20, 1.40, 20, 0.05)
	rune_entity("top_rune_3", "whaley-mid"		, "bot_rune_3", 96, 0.50, 1.40, 50, 0.15)

	rune_entity("bot_rune_1", "bell-3"			, "top_rune_1", 32, 0.20, 1.40, 30, 0.10)
	rune_entity("bot_rune_2", "rygg-3"			, "top_rune_2", 32, 0.20, 1.40, 30, 0.05)
	rune_entity("bot_rune_3", "whaley-whirly"	, "top_rune_3", 96, 0.50, 1.40, 50, 0.15)

M.desc_root.tileset = {
	ranges = {
		bg = {100, 199},
		fg = {200, 299},
		og = {300, 399},
	},
} -- tileset

-- desc_root ]]



M.intro_seq = {
	{name = "komiga"    , fade = 0.75, stay = 1.5},
	--{name = "disclaimer", fade = 0.5, stay = 2.0}
}

M.world = {
	menu = {
		layers = {
			[1] = {},
			[2] = {},
			[3] = {},
		},
		entities = {
			{"arc_torch" , -6,0},
			{"bot_rune_3", -4,0},
			{"arc_torch" , -2,0},

			{"arc_torch" , 2,0},
			{"top_rune_3", 4,0},
			{"arc_torch" , 6,0},
		},
	},
	t_start = {
		layers = {
			[1] = {[0] = {[-21]=101,[81]=103,}, [1] = {[-22]=101,[78]=101,}, [2] = {[78]=101,[77]=101,[79]=101,}, [-2] = {}, [-1] = {[-21]=101,}, [-3] = {[-21]=101,}, },
			[2] = {[0] = {[92]=203,[-72]=202,[91]=203,[-75]=203,[94]=203,[-76]=203,[-74]=203,[93]=203,[90]=201,[95]=203,[-73]=203,}, [1] = {[0]=200,[1]=200,[2]=200,[3]=200,[4]=200,[5]=200,[6]=200,[7]=200,[8]=200,[9]=200,[10]=200,[11]=200,[12]=200,[13]=200,[14]=200,[15]=200,[16]=200,[17]=200,[18]=200,[19]=200,[20]=200,[21]=200,[22]=200,[23]=200,[24]=200,[25]=200,[26]=200,[27]=200,[28]=200,[29]=200,[30]=200,[31]=200,[32]=200,[33]=200,[34]=200,[35]=200,[36]=200,[37]=200,[38]=200,[39]=200,[40]=200,[41]=200,[42]=200,[43]=200,[44]=200,[45]=200,[46]=200,[47]=200,[48]=200,[49]=200,[50]=200,[51]=200,[52]=200,[53]=200,[54]=200,[55]=200,[56]=200,[57]=200,[58]=200,[59]=200,[60]=200,[61]=200,[62]=200,[63]=200,[64]=200,[-2]=200,[-31]=200,[-11]=200,[-41]=200,[-56]=200,[82]=200,[93]=200,[-1]=200,[-63]=200,[92]=200,[-28]=200,[-62]=200,[94]=200,[-20]=200,[-46]=200,[-61]=200,[-14]=200,[-29]=200,[-45]=200,[-60]=200,[90]=200,[-21]=200,[-76]=200,[-70]=200,[-75]=200,[-74]=200,[-73]=200,[-71]=200,[-72]=200,[-51]=200,[95]=200,[-68]=200,[-26]=200,[91]=200,[89]=200,[-69]=200,[88]=200,[-50]=200,[-18]=200,[-66]=200,[87]=200,[-7]=200,[-44]=200,[-67]=200,[-13]=200,[-49]=200,[-6]=200,[83]=200,[-64]=200,[81]=200,[-9]=200,[-65]=200,[80]=200,[79]=200,[-48]=200,[67]=200,[75]=200,[72]=200,[77]=200,[-40]=200,[-55]=200,[73]=200,[76]=200,[71]=200,[70]=200,[69]=200,[-39]=200,[-33]=200,[-54]=200,[68]=200,[78]=200,[66]=200,[-16]=200,[65]=200,[-38]=200,[-34]=200,[-53]=200,[-32]=200,[-12]=200,[-36]=200,[-24]=200,[-25]=200,[-37]=200,[-35]=200,[-8]=200,[-47]=200,[74]=200,[-17]=200,[85]=200,[-52]=200,[-59]=200,[-27]=200,[84]=200,[-30]=200,[-43]=200,[-5]=200,[-4]=200,[-19]=200,[-58]=200,[-22]=200,[86]=200,[-23]=200,[-3]=200,[-10]=200,[-42]=200,[-15]=200,[-57]=200,}, },
			[3] = {[0] = {[0]=302,[1]=303,[2]=304,[3]=305,[4]=306,[5]=306,[6]=306,[7]=306,[8]=306,[9]=306,[10]=306,[11]=306,[12]=306,[13]=306,[14]=306,[15]=306,[16]=306,[17]=306,[18]=306,[19]=306,[20]=306,[88]=301,[-2]=306,[87]=306,[79]=306,[90]=303,[-20]=306,[-3]=306,[89]=302,[-1]=301,[78]=306,[77]=306,}, },
		},
		entities = {
			{"top_rune_1",-20,0},
			{"top_rune_2",24,0},
			{"arc_torch",50,0},
			{"top_rune_3",52,0},
			{"arc_torch",54,0},

			{"arc_torch",-4,0},
			{"arc_torch",4,0},
		},
	},
	b_start = {
		layers = {
			[1] = {[0] = {[-186]=101,[-147]=103,[-179]=101,[54]=102,[-184]=101,[-187]=101,[-143]=102,[-185]=101,[-182]=101,[-151]=102,[-178]=101,[-188]=101,[-180]=101,[-177]=101,[-181]=101,[-162]=101,}, [1] = {[-188]=101,[-168]=101,[-183]=101,[-176]=101,}, [2] = {[-175]=101,}, [-2] = {[-187]=101,[-185]=101,}, [-1] = {[-186]=101,[-181]=101,[-187]=101,[-185]=101,}, },
			[2] = {[0] = {[-195]=203,[-192]=202,[-193]=203,[64]=203,[62]=203,[-196]=203,[63]=203,[60]=201,[61]=203,[-194]=203,}, [1] = {[0]=200,[1]=200,[2]=200,[3]=200,[4]=200,[5]=200,[6]=200,[7]=200,[8]=200,[9]=200,[10]=200,[11]=200,[12]=200,[13]=200,[14]=200,[15]=200,[16]=200,[17]=200,[18]=200,[19]=200,[20]=200,[21]=200,[22]=200,[23]=200,[24]=200,[25]=200,[26]=200,[27]=200,[28]=200,[29]=200,[30]=200,[31]=200,[32]=200,[33]=200,[34]=200,[35]=200,[36]=200,[37]=200,[38]=200,[39]=200,[40]=200,[41]=200,[42]=200,[43]=200,[44]=200,[45]=200,[46]=200,[47]=200,[48]=200,[49]=200,[50]=200,[51]=200,[52]=200,[53]=200,[54]=200,[55]=200,[56]=200,[57]=200,[58]=200,[59]=200,[60]=200,[61]=200,[62]=200,[63]=200,[64]=200,[-2]=200,[-31]=200,[-114]=200,[-115]=200,[-56]=200,[-124]=200,[-1]=200,[-63]=200,[-126]=200,[-28]=200,[-127]=200,[-120]=200,[-121]=200,[-14]=200,[-122]=200,[-29]=200,[-123]=200,[-101]=200,[-7]=200,[-194]=200,[-195]=200,[-51]=200,[-192]=200,[-193]=200,[-26]=200,[-102]=200,[-50]=200,[-96]=200,[-13]=200,[-49]=200,[-27]=200,[-98]=200,[-48]=200,[-108]=200,[-55]=200,[-110]=200,[-24]=200,[-111]=200,[-104]=200,[-105]=200,[-12]=200,[-106]=200,[-25]=200,[-167]=200,[-57]=200,[-166]=200,[-91]=200,[-165]=200,[-142]=200,[-85]=200,[-44]=200,[-6]=200,[-60]=200,[-162]=200,[-188]=200,[-161]=200,[-89]=200,[-87]=200,[-160]=200,[-175]=200,[-22]=200,[-86]=200,[-20]=200,[-3]=200,[-58]=200,[-172]=200,[-97]=200,[-171]=200,[-61]=200,[-170]=200,[-80]=200,[-169]=200,[-11]=200,[-83]=200,[-95]=200,[-54]=200,[-182]=200,[-82]=200,[-183]=200,[-180]=200,[-93]=200,[-181]=200,[-40]=200,[-41]=200,[-178]=200,[-36]=200,[-179]=200,[-52]=200,[-176]=200,[-164]=200,[-177]=200,[-109]=200,[-94]=200,[-74]=200,[-191]=200,[-163]=200,[-46]=200,[-117]=200,[-189]=200,[-196]=200,[-186]=200,[-152]=200,[-187]=200,[-43]=200,[-45]=200,[-100]=200,[-10]=200,[-190]=200,[-136]=200,[-21]=200,[-137]=200,[-154]=200,[-138]=200,[-173]=200,[-139]=200,[-81]=200,[-71]=200,[-70]=200,[-5]=200,[-156]=200,[-68]=200,[-132]=200,[-143]=200,[-157]=200,[-69]=200,[-128]=200,[-129]=200,[-18]=200,[-66]=200,[-130]=200,[-131]=200,[-158]=200,[-67]=200,[-92]=200,[-133]=200,[-19]=200,[-134]=200,[-64]=200,[-135]=200,[-9]=200,[-65]=200,[-151]=200,[-79]=200,[-150]=200,[-39]=200,[-149]=200,[-62]=200,[-148]=200,[-32]=200,[-147]=200,[-146]=200,[-76]=200,[-42]=200,[-145]=200,[-77]=200,[-144]=200,[-33]=200,[-159]=200,[-184]=200,[-78]=200,[-84]=200,[-16]=200,[-125]=200,[-73]=200,[-34]=200,[-155]=200,[-174]=200,[-72]=200,[-103]=200,[-153]=200,[-99]=200,[-37]=200,[-35]=200,[-8]=200,[-107]=200,[-116]=200,[-17]=200,[-53]=200,[-38]=200,[-59]=200,[-185]=200,[-23]=200,[-30]=200,[-118]=200,[-47]=200,[-4]=200,[-168]=200,[-119]=200,[-88]=200,[-75]=200,[-141]=200,[-140]=200,[-112]=200,[-90]=200,[-15]=200,[-113]=200,}, },
			[3] = {[0] = {[0]=306,[1]=306,[57]=306,[-170]=300,[-163]=300,[-169]=300,[-134]=306,[-168]=300,[-135]=306,[-192]=303,[-182]=303,[-151]=303,[-183]=303,[-150]=303,[-180]=303,[-1]=306,[-181]=303,[-148]=305,[-178]=303,[-147]=306,[-179]=303,[-146]=301,[-176]=304,[-145]=302,[-177]=303,[-144]=303,[-190]=303,[-159]=300,[-191]=303,[-158]=300,[-188]=303,[-157]=300,[-189]=303,[-156]=300,[-186]=303,[-155]=300,[-187]=303,[-154]=300,[-184]=303,[-153]=301,[60]=303,[-167]=300,[-136]=306,[-166]=300,[-137]=305,[-165]=300,[-138]=304,[-164]=300,[-139]=303,[59]=302,[-140]=303,[-162]=300,[-141]=303,[-161]=300,[-142]=303,[-152]=302,[-143]=303,[58]=301,[-160]=300,[-174]=300,[-185]=303,[-173]=300,[-175]=305,[-172]=300,[-149]=304,[-171]=300,}, },
		},
		entities = {
			{"bot_rune_1",-86,0},
			{"bot_rune_2",16,0},

			{"arc_torch",-124,0},
			{"bot_rune_3",-126,0},
			{"arc_torch",-128,0},
		},
	},
}

function M.module_reload()
	Asset.font = nil
	Asset.atlas = nil
	Asset.anim = nil
	Asset.sound = nil
	Asset.entity = nil
	Asset.tileset = nil
	AssetLoader.load("asset/", Asset.desc_root, Asset)
end

return M
